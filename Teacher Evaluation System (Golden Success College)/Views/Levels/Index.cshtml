@model IEnumerable<Teacher_Evaluation_System__Golden_Success_College_.Models.Level>

@{
    ViewData["Title"] = "Levels";
    Layout = "_Layoutadmin";
}

<style>
    :root {
        --primary: #1e3a5f;
        --accent: #2e86de;
        --accent-light: #e8f1fb;
        --success: #27ae60;
        --warning: #f39c12;
        --danger: #e74c3c;
        --surface: #ffffff;
        --surface-2: #f4f7fb;
        --border: #dce3ee;
        --text: #1a2535;
        --text-muted: #6b7c99;
        --shadow: 0 2px 12px rgba(30,58,95,0.08);
        --radius: 10px;
    }

    body {
        background: var(--surface-2);
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary) 0%, #2c5282 100%);
        color: #fff;
        border-radius: var(--radius);
        padding: 24px 28px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 16px;
        box-shadow: 0 4px 20px rgba(30,58,95,0.2);
    }

        .page-header h1 {
            font-size: 1.7rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -.3px;
        }

        .page-header .subtitle {
            font-size: .88rem;
            opacity: .75;
            margin-top: 3px;
        }

    /* Stats */
    .stats-bar {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .stat-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px 20px;
        flex: 1 1 130px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

        .stat-card .stat-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
        }

        .stat-card .stat-label {
            font-size: .75rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .06em;
        }

    /* Filter */
    .filter-panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 18px 22px;
        margin-bottom: 20px;
        box-shadow: var(--shadow);
    }

    .filter-title {
        font-size: .78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: var(--text-muted);
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
        flex: 1 1 220px;
    }

        .filter-group label {
            font-size: .8rem;
            font-weight: 600;
            color: var(--text);
        }

        .filter-group input {
            border: 1px solid var(--border);
            border-radius: 7px;
            padding: 8px 12px;
            font-size: .88rem;
            color: var(--text);
            background: var(--surface-2);
            transition: border-color .2s;
            outline: none;
        }

            .filter-group input:focus {
                border-color: var(--accent);
                background: #fff;
            }

    .btn-filter-reset {
        padding: 8px 16px;
        border-radius: 7px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text-muted);
        font-size: .85rem;
        cursor: pointer;
        transition: all .2s;
        white-space: nowrap;
    }

        .btn-filter-reset:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

    /* Results */
    .results-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .results-count {
        font-size: .88rem;
        color: var(--text-muted);
    }

        .results-count strong {
            color: var(--primary);
        }

    /* View toggle */
    .view-switcher {
        display: flex;
        gap: 4px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 3px;
    }

    .view-btn {
        padding: 6px 14px;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: .82rem;
        font-weight: 600;
        cursor: pointer;
        transition: all .2s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

        .view-btn.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: 0 1px 4px rgba(0,0,0,.1);
        }

    /* Table */
    .table-panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .level-table {
        width: 100%;
        border-collapse: collapse;
    }

        .level-table thead tr {
            background: var(--surface-2);
        }

        .level-table th {
            padding: 10px 16px;
            font-size: .75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .07em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .level-table td {
            padding: 12px 16px;
            font-size: .88rem;
            border-bottom: 1px solid #f0f3f8;
            color: var(--text);
            vertical-align: middle;
        }

        .level-table tbody tr:last-child td {
            border-bottom: none;
        }

        .level-table tbody tr:hover {
            background: #f7faff;
        }

    .level-name-cell {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .level-icon {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: .8rem;
        font-weight: 800;
    }

    .level-desc {
        font-size: .82rem;
        color: var(--text-muted);
        max-width: 400px;
    }

    /* Card grid */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
        gap: 14px;
    }

    .level-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px 18px;
        box-shadow: var(--shadow);
        transition: transform .2s, box-shadow .2s;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

        .level-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(30,58,95,.12);
        }

    .lc-icon {
        width: 46px;
        height: 46px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 900;
        margin-bottom: 4px;
    }

    .lc-name {
        font-weight: 800;
        font-size: 1rem;
        color: var(--primary);
    }

    .lc-desc {
        font-size: .8rem;
        color: var(--text-muted);
        flex: 1;
    }

    .lc-actions {
        display: flex;
        gap: 6px;
        margin-top: 6px;
    }

    /* Action buttons */
    .btn-act {
        border: none;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: .8rem;
        cursor: pointer;
        transition: all .15s;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-weight: 600;
    }

        .btn-act:hover {
            filter: brightness(.88);
            transform: translateY(-1px);
        }

        .btn-act.edit {
            background: #fff3cd;
            color: #856404;
        }

        .btn-act.del {
            background: #f8d7da;
            color: #721c24;
        }

    /* Skeleton loading */
    .skeleton-row td {
        padding: 14px 16px;
    }

    .skeleton-line {
        height: 14px;
        border-radius: 6px;
        background: linear-gradient(90deg,#f0f3f8 25%,#e2e8f0 50%,#f0f3f8 75%);
        background-size: 200% 100%;
        animation: shimmer 1.4s infinite;
    }

    @@keyframes shimmer {
        0% {
            background-position: 200% 0
        }

        100% {
            background-position: -200% 0
        }
    }

    .no-results {
        text-align: center;
        padding: 50px 20px;
        color: var(--text-muted);
    }

        .no-results i {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 10px;
            opacity: .3;
        }

    #toast {
        min-width: 280px;
        border-radius: 10px;
        box-shadow: 0 6px 24px rgba(0,0,0,.15);
    }

    #loadingOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(255,255,255,.82);
        z-index: 9999;
        place-items: center;
    }

        #loadingOverlay.show {
            display: grid;
        }

    @@media (max-width: 576px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .filter-row {
            flex-direction: column;
        }
    }
</style>

<!-- Loading Overlay -->
<div id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width:3rem;height:3rem;"></div>
        <div class="mt-3 fw-bold text-primary">Loading...</div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:11000">
    <div id="toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Page Header -->
<div class="page-header">
    <div>
        <h1><i class="bi bi-layers-fill me-2"></i>Levels</h1>
        <div class="subtitle">Manage academic levels and programs</div>
    </div>
    <button class="btn btn-light fw-bold px-4" id="btnCreateLevel" style="border-radius:8px;">
        <i class="bi bi-plus-circle me-1"></i> Add Level
    </button>
</div>

<!-- Stats Bar -->
<div class="stats-bar">
    <div class="stat-card">
        <div class="stat-value" id="statTotal">—</div>
        <div class="stat-label">Total Levels</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statShowing">—</div>
        <div class="stat-label">Showing</div>
    </div>
</div>

<!-- Filter Panel -->
<div class="filter-panel">
    <div class="filter-title"><i class="bi bi-funnel-fill"></i> Filter Levels</div>
    <div class="filter-row">
        <div class="filter-group">
            <label><i class="bi bi-search"></i> Search</label>
            <input type="text" id="filterSearch" placeholder="Level name or description…" />
        </div>
        <div style="display:flex;gap:8px;padding-bottom:1px;">
            <button class="btn-filter-reset" id="btnReset"><i class="bi bi-x-circle me-1"></i>Reset</button>
        </div>
    </div>
</div>

<!-- Results Bar & View Switcher -->
<div class="results-bar">
    <div class="results-count" id="resultsCount">Loading…</div>
    <div class="view-switcher">
        <button class="view-btn active" id="btnTableView"><i class="bi bi-table"></i> Table</button>
        <button class="view-btn" id="btnCardView"><i class="bi bi-grid-3x3-gap"></i> Cards</button>
    </div>
</div>

<!-- Content -->
<div id="levelContent"></div>

<!-- ═══════════════ MODAL ═══════════════ -->
<div class="modal fade" id="levelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:12px;overflow:hidden;">
            <div class="modal-header" style="background:linear-gradient(135deg,#1e3a5f,#2c5282);color:#fff;">
                <h5 class="modal-title fw-bold" id="levelModalLabel">Create Level</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="levelForm" novalidate>
                    <input type="hidden" id="LevelId" />
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">Level Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="LevelName" placeholder="e.g. Senior High School, College…" required />
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Description</label>
                            <textarea class="form-control" id="Description" rows="3" placeholder="Optional description…"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background:#f8fafc;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary fw-bold px-4" id="saveLevelBtn">
                    <i class="bi bi-check-circle me-1"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script>
        $(function () {

            var allLevels  = [];
            var viewMode   = 'table';
            var filterText = '';
            var levelModal = new bootstrap.Modal(document.getElementById('levelModal'));

            /* ════════════ LOAD DATA ════════════ */
            function loadLevels() {
                showSkeletons();
                $.get('/api/LevelsApi', function (res) {
                    allLevels = res.success ? res.data : [];
                    render();
                }).fail(function () {
                    $('#levelContent').html('<div class="no-results"><i class="bi bi-exclamation-triangle"></i><div class="fw-bold">Failed to load levels</div></div>');
                    $('#resultsCount').text('Error loading data');
                });
            }

            function showSkeletons() {
                var rows = Array(3).fill(0).map(() =>
                    `<tr class="skeleton-row">
                        <td><div class="skeleton-line" style="width:60%;"></div></td>
                        <td><div class="skeleton-line" style="width:80%;"></div></td>
                        <td><div class="skeleton-line" style="width:40%;"></div></td>
                    </tr>`
                ).join('');
                $('#levelContent').html(`<div class="table-panel"><table class="level-table"><tbody>${rows}</tbody></table></div>`);
            }

            /* ════════════ FILTER ════════════ */
            function filtered() {
                var q = filterText.toLowerCase();
                if (!q) return allLevels;
                return allLevels.filter(function (l) {
                    return (l.levelName || '').toLowerCase().includes(q) ||
                           (l.description || '').toLowerCase().includes(q);
                });
            }

            /* ════════════ STATS ════════════ */
            function updateStats(list) {
                $('#statTotal').text(allLevels.length);
                $('#statShowing').text(list.length);
                $('#resultsCount').html(`Showing <strong>${list.length}</strong> level${list.length !== 1 ? 's' : ''}`);
            }

            /* ════════════ RENDER ════════════ */
            function render() {
                var list = filtered();
                updateStats(list);
                var $c = $('#levelContent').empty();

                if (list.length === 0) {
                    $c.html(`<div class="no-results"><i class="bi bi-layers"></i><div class="fw-bold">No levels found</div><div class="small mt-1">Try a different search or add a new level</div></div>`);
                    return;
                }

                if (viewMode === 'table') {
                    var rows = list.map(function (l) {
                        var initials = (l.levelName || 'L').substring(0, 2).toUpperCase();
                        var desc = l.description ? `<span class="level-desc">${l.description}</span>` : '<span class="text-muted small">—</span>';
                        return `<tr data-id="${l.levelId}">
                            <td>
                                <div class="level-name-cell">
                                    <div class="level-icon">${initials}</div>
                                    <strong>${l.levelName}</strong>
                                </div>
                            </td>
                            <td>${desc}</td>
                            <td>
                                <button class="btn-act edit btn-edit" data-id="${l.levelId}" title="Edit"><i class="bi bi-pencil-square"></i></button>
                            </td>
                        </tr>`;
                    }).join('');
                    $c.html(`
                        <div class="table-panel">
                            <table class="level-table">
                                <thead><tr>
                                    <th>Level Name</th>
                                    <th>Description</th>
                                    <th style="width:80px;">Actions</th>
                                </tr></thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>`);
                } else {
                    var cards = list.map(function (l) {
                        var initials = (l.levelName || 'L').substring(0, 2).toUpperCase();
                        var desc = l.description || '<span class="text-muted">No description</span>';
                        return `<div class="level-card" data-id="${l.levelId}">
                            <div class="lc-icon">${initials}</div>
                            <div class="lc-name">${l.levelName}</div>
                            <div class="lc-desc">${desc}</div>
                            <div class="lc-actions">
                                <button class="btn-act edit btn-edit" data-id="${l.levelId}"><i class="bi bi-pencil-square"></i> Edit</button>
                            </div>
                        </div>`;
                    }).join('');
                    $c.html(`<div class="card-grid">${cards}</div>`);
                }
            }

            /* ════════════ FILTER EVENTS ════════════ */
            var searchTimer;
            $('#filterSearch').on('input', function () {
                clearTimeout(searchTimer);
                var v = $(this).val();
                searchTimer = setTimeout(function () { filterText = v; render(); }, 200);
            });
            $('#btnReset').on('click', function () {
                filterText = '';
                $('#filterSearch').val('');
                render();
            });

            $('#btnTableView').on('click', function () {
                viewMode = 'table'; $(this).addClass('active'); $('#btnCardView').removeClass('active'); render();
            });
            $('#btnCardView').on('click', function () {
                viewMode = 'card'; $(this).addClass('active'); $('#btnTableView').removeClass('active'); render();
            });

            /* ════════════ TOAST / LOADING ════════════ */
            function showToast(msg, type) {
                var cls = { success:'bg-success text-white', danger:'bg-danger text-white', warning:'bg-warning text-dark' };
                $('#toast').removeClass('bg-success bg-danger bg-warning text-white text-dark').addClass(cls[type||'success']);
                $('#toastMessage').text(msg);
                new bootstrap.Toast($('#toast')[0], { autohide:true, delay:4000 }).show();
            }
            function showLoading(v) { v ? $('#loadingOverlay').addClass('show') : $('#loadingOverlay').removeClass('show'); }

            /* ════════════ CREATE ════════════ */
            $('#btnCreateLevel').on('click', function () {
                $('#levelModalLabel').text('Create Level');
                $('#levelForm')[0].reset();
                $('#LevelId').val('');
                levelModal.show();
            });

            /* ════════════ EDIT ════════════ */
            $(document).on('click', '.btn-edit', function () {
                var id = $(this).data('id');
                showLoading(true);
                $.get(`/api/LevelsApi/${id}`, function (res) {
                    showLoading(false);
                    if (!res.success) { showToast(res.message, 'danger'); return; }
                    var d = res.data;
                    $('#levelModalLabel').text('Edit Level');
                    $('#levelForm')[0].reset();
                    $('#LevelId').val(d.levelId);
                    $('#LevelName').val(d.levelName);
                    $('#Description').val(d.description);
                    levelModal.show();
                }).fail(function () { showLoading(false); showToast('Failed to load level.', 'danger'); });
            });

            /* ════════════ SAVE ════════════ */
            $('#saveLevelBtn').on('click', function () {
                var levelId = $('#LevelId').val();
                var isEdit  = !!levelId;
                var name    = $('#LevelName').val().trim();
                if (!name) { showToast('Level Name is required', 'danger'); return; }

                var payload = {
                    levelId:     isEdit ? parseInt(levelId) : 0,
                    levelName:   name,
                    description: $('#Description').val().trim()
                };

                showLoading(true);
                $.ajax({
                    url:  isEdit ? `/api/LevelsApi/${levelId}` : '/api/LevelsApi',
                    type: isEdit ? 'PUT' : 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (res) {
                        showLoading(false);
                        if (!res.success) { showToast(res.message, 'danger'); return; }
                        var d = res.data;
                        if (isEdit) {
                            var idx = allLevels.findIndex(l => l.levelId === d.levelId);
                            if (idx > -1) allLevels[idx] = d;
                        } else {
                            allLevels.push(d);
                        }
                        render();
                        showToast(res.message, 'success');
                        levelModal.hide();
                    },
                    error: function (xhr) {
                        showLoading(false);
                        showToast((xhr.responseJSON && xhr.responseJSON.message) || 'Failed to save level!', 'danger');
                    }
                });
            });

            /* ════════════ DELETE ════════════ */
            $(document).on('click', '.btn-delete', function () {
                var id   = $(this).data('id');
                var lvl  = allLevels.find(l => l.levelId === parseInt(id));
                var name = lvl ? lvl.levelName : 'this level';
                if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

                showLoading(true);
                $.ajax({
                    url: `/api/LevelsApi/${id}`, type: 'DELETE',
                    success: function (res) {
                        showLoading(false);
                        if (res.success) {
                            allLevels = allLevels.filter(l => l.levelId !== parseInt(id));
                            render();
                            showToast(res.message, 'success');
                        } else {
                            showToast(res.message, 'danger');
                        }
                    },
                    error: function () { showLoading(false); showToast('Failed to delete level!', 'danger'); }
                });
            });

            /* ─ Initial load ─ */
            loadLevels();
        });
    </script>
}
